---
- name: Install logstash
  apt: deb=https://download.elastic.co/logstash/logstash/packages/debian/logstash_2.3.1-1_all.deb

- name: Create cert directory
  file: path=/etc/pki/tls/certs state=directory mode=0755

- name: Create private directory
  file: path=/etc/pki/tls/private state=directory mode=0755

- name: Generate certificate
  shell: cd /etc/pki/tls; sudo openssl req -subj '/CN=logstash.brunograsselli.com/' -x509 -days 3650 -batch -nodes -newkey rsa:2048 -keyout private/logstash-forwarder.key -out certs/logstash-forwarder.crt

- name: Configure lumberjack input
  template: src=./templates/01-lumberjack-input.conf dest=/etc/logstash/conf.d/01-lumberjack-input.conf

- name: Configure syslog filter
  template: src=./templates/10-syslog.conf dest=/etc/logstash/conf.d/10-syslog.conf

- name: Configure lumberjack output
  template: src=./templates/30-lumberjack-output.conf dest=/etc/logstash/conf.d/30-lumberjack-output.conf

- name: Start logstash
  service: name=logstash state=started
